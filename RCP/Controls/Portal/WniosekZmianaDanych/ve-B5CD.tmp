using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data;
using System.ComponentModel;
using System.Drawing.Design;
using System.Configuration;
using HRRcp.App_Code;
namespace HRRcp.Controls.WnioseZmianaDanych
{
    public partial class cntlistview : System.Web.UI.UserControl
    {
      
        int Status = 0;
        int Typ = 0;
        public string Lvl { get; set; }
        /* user     1 - pracownik
         *          2 - Admin HR
         *               
         */
          
        protected void Page_Load(object sender, EventArgs e)
        {

            //if (Typ == 0) (ListView1.FindControl("ObWartosclb") as Label).Visible=false;
        }

        protected void ListView1_ItemDataBound(object sender, ListViewItemEventArgs e)
        {
            
            var Tb = e.Item.FindControl("asd") as TextBox;
            var De = e.Item.FindControl("asd2") as DateEdit;
            var Lb = e.Item.FindControl("asd3") as Label;
            ListViewDataItem dataItem = (ListViewDataItem)e.Item;
            int Type = (int)DataBinder.Eval(dataItem.DataItem, "Typ");

            if (Status > 0) // jesli wniosek został złożony.
            {
                De.Visible = false;
                Tb.Visible = false;
                Lb.Visible = true;
                Lb.Text = DataBinder.Eval(dataItem.DataItem, "Nowa_Wartosc").ToString();
            }
            else { // tworzenie wniosku

                Lb.Visible = false;
                switch (Type)
                { //// tworzenie kontroli (label lub dateedit) 
                    case 0:
                        De.Visible = false;
                        break;
                    case 1:
                        Tb.Visible = false;
                        break;

                }
            
            
            }


            if (Typ == 0) e.Item.FindControl("Obecna_wartoscLabel").Visible = false;
            if (Typ == 2)
            {
                e.Item.FindControl("asd3").Visible = false;
                switch (Type) {
                    case 0: e.Item.FindControl("asd").Visible = false; break;
                    case 1: e.Item.FindControl("asd2").Visible = false; break;
                }
                

            }


                
            
        }
        public void Zoom(String Id) {
            //ListView1.FindControl("Button1").Visible = false; // chowanie przycisku wysyłania wniosku , już jest wysłany
            ListView1.Visible = true;
            Dane_Pracownika.Visible = true;
            DataRow dr = db.getDataRow(String.Format(@"select 
WO.Typ,
WU.Status,
WU.Id 
from Wnioski_dane_osobowe_Info WO 
left outer join poWnioskiUrlopoweStatusy WU on WU.Id=WO.StatusId 
where WO.Id={0}", Id));// pobranie statusu wniosku 
            Imie_Nazwisko.Text = App.User.ImieNazwisko;
            Nrewid.Text = App.User.NR_EW;
            Status_Wniosku.Text = db.getValue(dr, "Status");
            Status = int.Parse(db.getValue(dr, "Id").ToString());
            Typ = int.Parse(db.getValue(dr, "Typ").ToString());
            switch (Typ) {
                case 0:
                    Temat.Text = "Wniosek o dodanie nowych Danych";
                    break;
                case 1:
                    Temat.Text = "Wniosek o modyfikację obecnych danych";
                    break;
                case 2 :
                    Temat.Text = "Wniosek o Skasowanie obecnych danych";
                    break;
            }
            SqlDataSource1.SelectCommand = string.Format(@"
select Nazwa_pola,Obecna_wartosc,Typ,Nowa_Wartosc from Wnioski_dane_osobowe_Pola where WniosekId={0}",Id);// pobranie pol
        }
        public void Pokaz(String id) {
            DataRow dr = db.getDataRow(String.Format(@"select 
WO.Typ,
WU.Status,
WU.Id 
from Wnioski_dane_osobowe_Info WO 
left outer join poWnioskiUrlopoweStatusy WU on WU.Id=WO.StatusId 
where WO.Id={0}", id));// pobranie statusu wniosku
            Typ = int.Parse(db.getValue(dr, "Typ").ToString());
            WniosekId.Value = id.ToString();
            ListView1.Visible = true;
            SqlDataSource1.SelectCommand = string.Format(@"
select Nazwa_pola,Obecna_wartosc,Typ from Wnioski_dane_osobowe_Pola where WniosekId={0}",id); // pobranie pol
            
        }

        protected void Button1_Click(object sender, EventArgs e) // dodawanie nowych wartosci
        {string Value="";
        int Index = 0;
        db.insert(String.Format(@"update Wnioski_dane_osobowe_Info set StatusId=1 where Id={0};",WniosekId.Value));
            foreach (ListViewItem item in ListView1.Items)
            {
                 
                var Tb = item.FindControl("asd") as TextBox;
                var De = item.FindControl("asd2") as DateEdit;
                if (Tb.Visible == true) Value = Tb.Text.ToString();
                if (De.Visible == true) Value = (De.FindControl("tbDate") as TextBox).Text;
                db.insert(String.Format(@"update Wnioski_dane_osobowe_Pola set Nowa_Wartosc='{0}' where WniosekId={1} and IdPola='{2}'", Value
                                                                                                                                           ,WniosekId.Value
                                                                                                                                           ,Index));
                Index++;
            }

            ListView1.Visible = false;
        }

        protected void ListView1_DataBinding(object sender, EventArgs e)
        {
            if (Typ==0)(ListView1.FindControl("ObWartosclb") as Label).Visible=false;
            if (Typ == 2) (ListView1.FindControl("NwWartosclb") as Label).Visible = false;
            
            
        }

    }
}